<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>gsi-anno-voronoi</title>
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
<link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>
<script src="//cdn.rawgit.com/mlevans/leaflet-hash/master/leaflet-hash.js"></script>
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
<style>
body {
	width: 100%;
	height: 100%;
	overflow: hidden;
}

#map {
	position: absolute;
	top: 0;
	left: 0;
	bottom: 20px;
	width: 100%;
	height: auto;
}

#footer {
	position: absolute;
	bottom: 0;
	left: 0;
	width: 100%;
	height: 20px;
	text-align: center;
	background: black;
	color: white;
	font-size: 12pt;
	font-weight: bold;
	font-family: Meiryo, sans-serif;
}

#footer * {
	margin: auto 0.5em;
}

#footer code {
	font-family: Consolas, monospace;
}
</style>
</head>
<body>
	<div id="map"></div>
	<footer id="footer"></footer>
	<script>
		var styles = {
			shadow : {
				color : "#000",
				opacity : 1.0,
				fill : false,
				weight : 5
			},
			on : {
				color : "#f80",
				opacity : 1.0,
				fill : true,
				fillColor : "#000",
				fillOpacity : 0.4,
				weight : 3
			},
			off : {
				color : "#f80",
				opacity : 1.0,
				fill : true,
				fillColor : "#000",
				fillOpacity : 0.1,
				weight : 3
			}
		};

		var polylineHandler = {
			"mouseover" : function() {
				this.setStyle(styles.on);
				var a = this.properties;
				var b = $("#footer");
				b.empty().append($("<span/>").text(a.knj));
				if (a.kana && a.kana.length > 0)
					b.append($("<small/>").text(a.kana));
				b.append($("<code/>").text(a.rID));
			},
			"mouseout" : function() {
				this.setStyle(styles.off);
			}
		};

		var promises = [];
		var tileLayerHandler = {
			"loading" : function(a) {
				promises = [];
			},
			"tileloadstart" : function(a) {
				var b = a.url.replace("ort", "experimental_anno").replace(".jpg", ".geojson");
				promises.push($.getJSON(b));
			},
			"load" : function(a) {
				$.when.apply(null, promises).done(onDone);
			}
		};

		var points = [];

		var onDone = function() {
			$.each(arguments, function(i, v) {
				if (!v[0] || !v[0].features)
					return;
				$.each(v[0].features, function(j, w) {
					if (w.properties.annoCtg != "居住地名（町字名）")
						return;
					points.push([ w.geometry.coordinates[1], w.geometry.coordinates[0], w.properties ]);
				});
			});

			fg.clearLayers();
			var z = d3.geom.voronoi(points);
			$.each(z, function(i, v) {
				if (!v)
					return;
				fg.addLayer(L.polyline(v, styles.shadow));
			});
			$.each(z, function(i, v) {
				if (!v)
					return;
				var x = L.polyline(v, styles.off);
				x.properties = v.point[2];
				x.on(polylineHandler, x);
				fg.addLayer(x);
			});
		};

		var bg = L.tileLayer('http://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', {
			attribution : "<a href='http://maps.gsi.go.jp/development/'>地理院タイル・オルソ画像(国土地理院)</a>"
		}).on(tileLayerHandler);

		var fg = L.layerGroup([]);

		var map = L.map("map", L.extend({
			minZoom : 15,
			maxZoom : 18,
			layers : [ bg, fg ]
		}, L.Hash.parseHash(location.hash) || {
			zoom : 15,
			center : [ 35.6439, 139.663116 ]
		}));
		map.attributionControl.addAttribution("<a href='https://github.com/gsi-cyberjapan/experimental_anno'>"
				+ "国土地理院ベクトルタイル提供実験（地図情報（注記））</a>");
		new L.Hash(map);
	</script>
</body>
</html>
